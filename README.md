# ConditionalLove

This repository contains the code and data to reproduce the analysis described in:
de Jonge, M. M. J., Benítez-López, A., Hennekens, S., Santini, L., Huijbregts, M. A. J. & Schipper, A. M. <i>Contitional love? Evidence for the stress gradient hypothesis in dry grasslands across Euope.</i> 

Code and data needed to reproduce the pre-processing steps are not made available due to restrictions on publication of third party data. 

## Model in MATLAB
The following steps should be taken to replicate the Joint-SDMs described in the paper: 

Step 1: Run the main model for 1100 runs of 2500 iterations saving only every tenth iteration in MATLAB using run_model(1,1,1100,250,10,3). You can also run the static model with run_static_model(1,1,1100,250,10,3). The posterior estimates generated by this step are saved in the output folder. WARNING: This step may take a long time, in the order of weeks, and the output can take up almost 1TB storage space. 

Step 2: Check the potential scale reduction factors of the beta & omega parameters of the model after 600 runs using check_convergence('Conditional',1,0,600) and of the static model using check_convergence('Static',1,0,600). Trace plots and Gelman-Rubin plots are saved in the 'figures' directory. For the conditional model you need to specify the quantile of the CWD (for example, q=0.5 for the median) at which the omega parameters are calculated. 

If needed, you can sample more iterations starting from the last run. Example, if you want to sample an additional 100 runs starting from run 1101: run_model(1,1101,1200,250,10,3)

Step 3: If the models are converged combine the postiors of the runs after discard the burnin period (600 runs) into one model object and calculate the residual correlations of the species using finalize_model('Conditional',1,600,1100,25) and finalize_model('Static',1,600,1100,25).

From the top directory of this repository in MATLAB:
```
addpath('MATLAB')
run_static_model(1,1,1100,250,10,3) %run_model(id,startN,repN,niter,thinning,chains)
run_model(1,1,1100,250,10,3)
check_convergence('Conditional',1,1,1100,250,3,0.5) %check_convergence(model,id,startN,repN,niter,chains,q)
check_convergence('Static',1,1,1100,250,3,0.5)
finalize_model('Static',1,600,1100,3,250,10,25) %finalize_model(model,id,burnin,repN,chains,niter,thinning,extrathinning)
finalize_model('Conditional',1,600,1100,3,250,10,25)
```

## Analysis in R
To replicate the analysis of the model and figures, first calculate the mean and confidence intervals of the residual associations along the gradient for the conditional model using meanAssociationGradient(1) and determine for each pairwise association if they differ at the 75th percentile of the gradient as compared to the 25th. Figure 3 and 4 of the manuscript can then be reproduced with CAPlots() and makePairwiseFigures(). 

```r
source(file.path('R','meanAssociationGradient.R'))
source(file.path('R','associationChange.R'))
source(file.path('R','makePairwiseFigures.R'))

meanAssociationGradient(1)
associationChange(1)
makePairwiseFigures(1)

```
To make the plots with the community association and the predicted species richness along the gradient you first need to make predictions along the gradient in matlab.

From the top directory of this repository in MATLAB:
```
addpath('MATLAB')
response_gradient('Conditional',1,3,500) %response_gradient(model,id,chains,nPred)
```

Then in R:
```r
source(file.path('R','CAPlots.R'))
CAPlots(1)
```

## Checking residuals of fixed effects part of the model
Species' associations are based on variance not explained by the environment. Calculate the scaled residuals based on unconditional model predictions (species' associations are disregarded) and test if these are biased along the CWD gradient.  

1. From MATLAB, calculate the unconditional predicitons of the original data. The predictions are stored in the corresponding model folder. 
```
addpath('MATLAB')
unconditional_predictions(1000,1,3) %unconditional_predictions(nPred,id,nchains)
```

2. Calculate scaled residuals using the DHARMa package, plot them across the CWD gradient for each species and calculate the regression slope of the scaled residuals to the CWD for all species.  

```r
source(file.path('R','checkResiduals.R'))
checkResiduals(1)
```

## Effective sample size
To calculate the effective sample size of the beta parameters and omega estimates:
```r
source(file.path('R','EffectiveSampleSize.R'))
EffectiveSampleSize(1)
```
Figures are store in the figures folder.


This repository includes the HMSC package V2.1 for MATLAB which can be found at: https://www.helsinki.fi/en/researchgroups/statistical-ecology/software/old-versions-of-hmsc

 
